<!DOCTYPE html>  <html> <head>   <title>export.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.js               </a>                                           <a class="source" href="export.html">                 export.js               </a>                                           <a class="source" href="library.html">                 library.js               </a>                                           <a class="source" href="parsemss.html">                 parsemss.js               </a>                                           <a class="source" href="project-layer.html">                 project-layer.js               </a>                                           <a class="source" href="project-map.html">                 project-map.js               </a>                                           <a class="source" href="project-reference.html">                 project-reference.js               </a>                                           <a class="source" href="project-stylesheet.html">                 project-stylesheet.js               </a>                                           <a class="source" href="project-tools.html">                 project-tools.js               </a>                                           <a class="source" href="project.html">                 project.js               </a>                                           <a class="source" href="utils.html">                 utils.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               export.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>ExportListView</h2>

<p>List of all exports. Available as a pane from LibraryListView.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportListView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;render&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.exports&#39;</span><span class="p">).</span><span class="nx">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">ich</span><span class="p">.</span><span class="nx">ExportListView</span><span class="p">({},</span> <span class="kc">true</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xport</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">xport</span><span class="p">.</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">xport</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExportRowView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">xport</span> <span class="p">});</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.exports&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">xport</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>ExportDrawerView</h2>

<p>Shows a list of current exports from an ExportList collection in a sidebar
drawer.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportDrawerView</span> <span class="o">=</span> <span class="nx">DrawerView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Exports&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">ich</span><span class="p">.</span><span class="nx">ExportDrawerView</span><span class="p">({},</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;render&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">renderExports</span><span class="p">);</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">saveLocation</span><span class="p">(</span><span class="s1">&#39;project/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/export&#39;</span><span class="p">);</span>
        <span class="nx">DrawerView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">renderExports</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xport</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">xport</span><span class="p">.</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">xport</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExportRowView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">xport</span> <span class="p">});</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.exports&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">xport</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">saveLocation</span><span class="p">(</span><span class="s1">&#39;project/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">DrawerView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>View: ExportRowView</h2>

<p>A single job row in an ExportListView or ExportDrawerView. Uses <code>Watcher</code> to
update the progress display of each job and provides download/delete actions
for each export.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportRowView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">tagName</span><span class="o">:</span> <span class="s1">&#39;li&#39;</span><span class="p">,</span>
    <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;clearfix&#39;</span><span class="p">,</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;click a.delete&#39;</span><span class="o">:</span> <span class="s1">&#39;destroy&#39;</span>
    <span class="p">},</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;render&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>If this model has not been processed, add a watcher to update its status.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;complete&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">watcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Watcher</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Remove watcher when complete.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;complete&#39;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">watcher</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">ich</span><span class="p">.</span><span class="nx">ExportRowView</span><span class="p">({</span>
            <span class="nx">time</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">time</span><span class="p">(),</span>
            <span class="nx">progress</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="nx">progressClass</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="nx">filename</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">),</span>
            <span class="nx">status</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">),</span>
            <span class="nx">error</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
            <span class="nx">format</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">),</span>
            <span class="nx">download</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">downloadURL</span><span class="p">()</span>
        <span class="p">}));</span>
    <span class="p">},</span>
    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">confirm</span><span class="p">(</span><span class="s1">&#39;Are you sure you want to delete this export?&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
                <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
                <span class="p">},</span>
                <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;The job could not be deleted.&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>ExportView</h2>

<p>Abstract view for the project export form.</p>

<ul>
<li><code>options.model</code> Export model</li>
<li><code>options.project</code> Project model</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;ExportView&#39;</span><span class="p">,</span>
    <span class="nx">events</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="s1">&#39;click a.reset&#39;</span><span class="o">:</span> <span class="s1">&#39;boundingBoxReset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;click input.submit&#39;</span><span class="o">:</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;change input&#39;</span><span class="o">:</span> <span class="s1">&#39;updateModel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;change select&#39;</span><span class="o">:</span> <span class="s1">&#39;updateModel&#39;</span>
    <span class="p">},</span> <span class="nx">PopupView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">events</span><span class="p">),</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;boundingBoxAdded&#39;</span><span class="p">,</span> <span class="s1">&#39;boundingBoxReset&#39;</span><span class="p">,</span> <span class="s1">&#39;updateModel&#39;</span><span class="p">,</span> <span class="s1">&#39;updateUI&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateUI</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">bbox</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getExtent</span><span class="p">().</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">});</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">saveLocation</span><span class="p">(</span><span class="s1">&#39;project/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/export/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">ich</span><span class="p">.</span><span class="nx">ExportView</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">));</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">maximize</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Add crop control to map.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="s1">&#39;Crop&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingControl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExportCropControl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingLayer</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">featureAdded</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boundingBoxAdded</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingLayer</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingControl</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingControl</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>OpenLayers ExportCropControl callback. Sets the bounding box of the
model when a user drags a crop box over the map.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">boundingBoxAdded</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">box</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
            <span class="nx">bbox</span><span class="o">:</span> <span class="nx">box</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">getBounds</span><span class="p">().</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Resets the bounding box of the model to the maximum layer extents.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">boundingBoxReset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
            <span class="nx">bbox</span><span class="o">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">20037500</span><span class="p">,</span> <span class="o">-</span><span class="mi">20037500</span><span class="p">,</span> <span class="mi">20037500</span><span class="p">,</span> <span class="mi">20037500</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Update the export model from form fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">updateModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;.bbox&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">bbox</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">parseFloat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-w&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()),</span>
                <span class="nb">parseFloat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-s&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()),</span>
                <span class="nb">parseFloat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-e&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()),</span>
                <span class="nb">parseFloat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-n&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">())</span>
            <span class="p">];</span>
            <span class="kd">var</span> <span class="nx">nw</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span>
                <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">},</span>
                <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">),</span>
                <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:900913&#39;</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="kd">var</span> <span class="nx">se</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span>
                <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">},</span>
                <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">),</span>
                <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:900913&#39;</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">bbox</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">nw</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">se</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">se</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">nw</span><span class="p">.</span><span class="nx">y</span> <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">[</span><span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Update form field values when model values change.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">updateUI</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">changedAttributes</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;bbox&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">bbox</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">nw</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span>
                    <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">},</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:900913&#39;</span><span class="p">),</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
                <span class="p">);</span>
                <span class="kd">var</span> <span class="nx">se</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span>
                    <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">},</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:900913&#39;</span><span class="p">),</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
                <span class="p">);</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-w&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">nw</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-s&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">se</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-e&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">se</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#bbox-n&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">nw</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">boxDrawingControl</span><span class="p">.</span><span class="nx">drawFeature</span><span class="p">(</span><span class="nx">bbox</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">submit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="k">new</span> <span class="nx">ExportDrawerView</span><span class="p">({</span>
            <span class="nx">collection</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ExportList</span><span class="p">(),</span>
            <span class="nx">project</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingControl</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">removeControl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingControl</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">removeLayer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxDrawingLayer</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">minimize</span><span class="p">();</span>
        <span class="nx">PopupView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">saveLocation</span><span class="p">(</span><span class="s1">&#39;project/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>ExportImageView</h2>

<p>Abstract image export class. The following properites should be populated
in <code>initialize</code> before calling the parent method when extending this class:</p>

<ul>
<li>'this.options.extension' file format extension for this export format.</li>
<li>'this.options.title' user-friendly name for this export format.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportImageView</span> <span class="o">=</span> <span class="nx">ExportView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ExportView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getSize</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
            <span class="nx">filename</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">extension</span><span class="p">,</span>
            <span class="nx">width</span><span class="o">:</span> <span class="nx">size</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span>
            <span class="nx">height</span><span class="o">:</span> <span class="nx">size</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span>
            <span class="nx">aspect</span><span class="o">:</span> <span class="nx">size</span><span class="p">.</span><span class="nx">w</span> <span class="o">/</span> <span class="nx">size</span><span class="p">.</span><span class="nx">h</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change:width&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateDimensions</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change:height&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateDimensions</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change:aspect&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateDimensions</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ExportView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.palette&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">ich</span><span class="p">.</span><span class="nx">ExportImageView</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">boundingBoxAdded</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">box</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">bounds</span> <span class="o">=</span> <span class="nx">box</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">getBounds</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">aspect</span><span class="o">:</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">()</span> <span class="o">/</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()});</span>
        <span class="nx">ExportView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">boundingBoxAdded</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">box</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Update the image width or height based on the bounding box aspect ratio
when the user changes one of the w/h/bbox values.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">updateDimensions</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">changedAttributes</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
                <span class="nx">height</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;aspect&#39;</span><span class="p">))},</span>
                <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
                <span class="nx">width</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;aspect&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">height</span><span class="p">)},</span>
                <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">aspect</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
                <span class="nx">height</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">aspect</span><span class="p">)},</span>
                <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>PDF format</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportPDFView</span> <span class="o">=</span> <span class="nx">ExportImageView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Export PDF&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">extension</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span><span class="p">;</span>
        <span class="nx">ExportImageView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>PNG format</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportPNGView</span> <span class="o">=</span> <span class="nx">ExportImageView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Export PNG&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">extension</span> <span class="o">=</span> <span class="s1">&#39;png&#39;</span><span class="p">;</span>
        <span class="nx">ExportImageView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>ExportMBTilesView</h2>

<p>MBTiles export form. MBTiles exports include a range of zoom levels to
render as well as key/value metadata pairs for describing the mbtiles data
itself.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportMBTilesView</span> <span class="o">=</span> <span class="nx">ExportView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;changeZoomLevels&#39;</span><span class="p">,</span> <span class="s1">&#39;updateZoomLabels&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Export MBTiles&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">extension</span> <span class="o">=</span> <span class="s1">&#39;mbtiles&#39;</span><span class="p">;</span>
        <span class="nx">ExportView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Set default values.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
            <span class="nx">filename</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">extension</span><span class="p">,</span>
            <span class="nx">minzoom</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">maxzoom</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="nx">tile_format</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;_format&#39;</span><span class="p">),</span>
            <span class="nx">metadata_name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="nx">metadata_description</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="nx">metadata_version</span><span class="o">:</span> <span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span>
            <span class="nx">metadata_type</span><span class="o">:</span> <span class="s1">&#39;baselayer&#39;</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ExportView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.palette&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">ich</span><span class="p">.</span><span class="nx">ExportMBTilesView</span><span class="p">({</span>
            <span class="nx">minzoom</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;minzoom&#39;</span><span class="p">),</span>
            <span class="nx">maxzoom</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;maxzoom&#39;</span><span class="p">),</span>
            <span class="nx">metadata_name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;metadata_name&#39;</span><span class="p">),</span>
            <span class="nx">metadata_description</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;metadata_description&#39;</span><span class="p">),</span>
            <span class="nx">metadata_version</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;metadata_version&#39;</span><span class="p">),</span>
            <span class="nx">metadata_type_baselayer</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;metadata_type&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;baselayer&#39;</span>
        <span class="p">}));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#mbtiles-zoom&#39;</span><span class="p">).</span><span class="nx">slider</span><span class="p">({</span>
            <span class="nx">range</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">min</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nx">max</span><span class="o">:</span><span class="mi">22</span><span class="p">,</span>
            <span class="nx">step</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nx">slide</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateModel</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">updateModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">ui</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ExportView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateModel</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;#mbtiles-zoom&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
                <span class="nx">minzoom</span><span class="o">:</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="nx">maxzoom</span><span class="o">:</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">updateUI</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ExportView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateUI</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#mbtiles-zoom&#39;</span><span class="p">).</span><span class="nx">slider</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;minzoom&#39;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#mbtiles-zoom&#39;</span><span class="p">).</span><span class="nx">slider</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;maxzoom&#39;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;span.min-zoom&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;minzoom&#39;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;span.max-zoom&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;maxzoom&#39;</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>ExportDropdownView</h2>

<p>Dropdown menu for selecting the export format for a project.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportDropdownView</span> <span class="o">=</span> <span class="nx">DropdownView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">FORMAT</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">png</span><span class="o">:</span> <span class="nx">ExportPNGView</span><span class="p">,</span>
        <span class="nx">pdf</span><span class="o">:</span> <span class="nx">ExportPDFView</span><span class="p">,</span>
        <span class="nx">mbtiles</span><span class="o">:</span> <span class="nx">ExportMBTilesView</span>
    <span class="p">},</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;xport&#39;</span><span class="p">,</span> <span class="s1">&#39;exportList&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">project</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">project</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Export&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">ich</span><span class="p">.</span><span class="nx">ExportOptions</span><span class="p">(</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">abilities</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;exports&#39;</span><span class="p">),</span>
            <span class="kc">true</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">events</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="s1">&#39;click a.export-option&#39;</span><span class="o">:</span> <span class="s1">&#39;xport&#39;</span><span class="p">,</span>
        <span class="s1">&#39;click a.exports&#39;</span><span class="o">:</span> <span class="s1">&#39;exportList&#39;</span>
    <span class="p">},</span> <span class="nx">DropdownView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">events</span><span class="p">),</span>
    <span class="nx">xport</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">event</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span>
            <span class="o">?</span> <span class="nx">event</span>
            <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">FORMAT</span><span class="p">[</span><span class="nx">format</span><span class="p">])</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unsupported export format.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">FORMAT</span><span class="p">[</span><span class="nx">format</span><span class="p">]({</span>
                <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Export</span><span class="p">({</span>
                    <span class="nx">mapfile</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">safe64</span><span class="p">(</span>
                        <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">baseURL</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span>
                    <span class="p">),</span>
                    <span class="nx">format</span><span class="o">:</span> <span class="nx">format</span>
                <span class="p">}),</span>
                <span class="nx">project</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">project</span><span class="p">,</span>
                <span class="nx">collection</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
                <span class="nx">map</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
                <span class="nx">format</span><span class="o">:</span> <span class="nx">format</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hideContent</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">exportList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">new</span> <span class="nx">ExportDrawerView</span><span class="p">({</span>
            <span class="nx">project</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">project</span><span class="p">,</span>
            <span class="nx">collection</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ExportList</span><span class="p">()</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hideContent</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>ExportCropControl</h2>

<p>Custom OpenLayers control for generating a masked crop box over the map.
Assumes 900913 projection for extent of masked area.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">ExportCropControl</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Class</span><span class="p">(</span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">CLASS_NAME</span><span class="o">:</span> <span class="s1">&#39;ExportCropControl&#39;</span><span class="p">,</span>
    <span class="nx">EVENT_TYPES</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;featureadded&#39;</span><span class="p">],</span>

    <span class="nx">layer</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">canvas</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">feature</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">callbacks</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">multi</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">featureAdded</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>
    <span class="nx">handlerOptions</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">layer</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>concatenate events specific to vector with those from the base</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">EVENT_TYPES</span> <span class="o">=</span>
            <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">DrawFeature</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">EVENT_TYPES</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
            <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">EVENT_TYPES</span>
        <span class="p">);</span>
        <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Util</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
            <span class="p">{</span> <span class="nx">done</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">drawFeature</span> <span class="p">},</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">layer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set handler style and options.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span> <span class="o">||</span> <span class="p">{</span>
            <span class="s1">&#39;keyMask&#39;</span><span class="o">:</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">MOD_SHIFT</span><span class="p">,</span>
            <span class="s1">&#39;sides&#39;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;irregular&#39;</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Util</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span> <span class="p">{</span>
            <span class="nx">fillColor</span><span class="o">:</span> <span class="s1">&#39;#000&#39;</span><span class="p">,</span>
            <span class="nx">fillOpacity</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span><span class="p">.</span><span class="nx">layerOptions</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Util</span><span class="p">.</span><span class="nx">applyDefaults</span><span class="p">(</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span><span class="p">.</span><span class="nx">layerOptions</span><span class="p">,</span>
            <span class="p">{</span><span class="nx">styleMap</span><span class="o">:</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">StyleMap</span><span class="p">({</span><span class="s2">&quot;default&quot;</span><span class="o">:</span> <span class="nx">style</span><span class="p">})}</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">RegularPolygon</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlerOptions</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Draw initial handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">bounds</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">||</span> <span class="p">[</span><span class="o">-</span><span class="mi">10000000</span><span class="p">,</span> <span class="o">-</span><span class="mi">10000000</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">LinearRing</span><span class="p">([</span>
            <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="mi">20037500</span><span class="p">,</span> <span class="mi">20037500</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="mi">20037500</span><span class="p">,</span> <span class="mi">20037500</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="mi">20037500</span><span class="p">,</span> <span class="o">-</span><span class="mi">20037500</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="mi">20037500</span><span class="p">,</span> <span class="o">-</span><span class="mi">20037500</span><span class="p">)</span>
        <span class="p">]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">feature</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">([</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span>
                <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">LinearRing</span><span class="p">([</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">])</span>
            <span class="p">])</span>
        <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">feature</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nx">INSERT</span><span class="p">;</span>
        <span class="nx">layer</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">feature</span><span class="p">]);</span>
    <span class="p">},</span>

    <span class="nx">drawFeature</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">geometry</span><span class="p">,</span> <span class="nx">quiet</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">feature</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">components</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">feature</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span>
                <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">([</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span>
                    <span class="nx">geometry</span><span class="p">.</span><span class="nx">components</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
                <span class="p">])</span>
            <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Allow a straight bbox to be passed in.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">feature</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span>
                <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">([</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span>
                    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">LinearRing</span><span class="p">([</span>
                        <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">geometry</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                        <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">geometry</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">geometry</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                        <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">geometry</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">])</span>
                <span class="p">])</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">proceed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">triggerEvent</span><span class="p">(</span>
            <span class="s2">&quot;sketchcomplete&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">feature</span><span class="o">:</span> <span class="nx">feature</span><span class="p">}</span>
        <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">proceed</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">feature</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nx">INSERT</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Replace this.feature with the new feature.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">feature</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">feature</span> <span class="o">=</span> <span class="nx">feature</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">([</span><span class="nx">feature</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quiet</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">featureAdded</span><span class="p">(</span><span class="nx">feature</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">triggerEvent</span><span class="p">(</span><span class="s2">&quot;featureadded&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">feature</span> <span class="o">:</span> <span class="nx">feature</span> <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 